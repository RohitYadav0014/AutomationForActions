/**
 * Enterprise Playwright Framework — Client Jenkinsfile
 *
 * This pipeline is shipped to clients as part of the protected distribution.
 * It uses the obfuscated framework CLI (framework.obf.js) to run tests.
 *
 * Jenkins requirements:
 *   - Node.js 18+ installed (or NodeJS plugin configured)
 *   - Allure Jenkins plugin (optional, for Allure reports)
 *   - HTML Publisher plugin (for Playwright HTML reports)
 */

pipeline {
    agent any

    options {
        timestamps()
        timeout(time: 60, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '30', artifactNumToKeepStr: '10'))
    }

    environment {
        NODE_ENV     = 'production'
        CI           = 'true'
    }

    stages {

        stage('Install Dependencies') {
            steps {
                script {
                    if (isUnix()) {
                        sh 'npm install --production'
                    } else {
                        bat 'npm install --production'
                    }
                }
            }
        }

        stage('Install Browsers') {
            steps {
                script {
                    if (isUnix()) {
                        sh 'npx playwright install --with-deps chromium'
                    } else {
                        bat 'npx playwright install chromium'
                    }
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    def cmd = "node framework.obf.js run --config configs/clientEG.json"

                    echo "Executing: ${cmd}"

                    catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                        if (isUnix()) {
                            sh cmd
                        } else {
                            bat cmd
                        }
                    }
                }
            }
        }

        stage('Publish Reports') {
            parallel {
                stage('Playwright HTML Report') {
                    steps {
                        publishHTML([
                            allowMissing: true,
                            alwaysLinkToLastBuild: true,
                            keepAll: true,
                            reportDir: 'playwright-report',
                            reportFiles: 'index.html',
                            reportName: 'Playwright Report'
                        ])
                    }
                }
                stage('Allure Report') {
                    when {
                        expression { fileExists('allure-results') }
                    }
                    steps {
                        allure([
                            includeProperties: false,
                            results: [[path: 'allure-results']]
                        ])
                    }
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'playwright-report/**', fingerprint: true, allowEmptyArchive: true
            archiveArtifacts artifacts: 'allure-results/**', fingerprint: true, allowEmptyArchive: true
            archiveArtifacts artifacts: 'allure-report/**', fingerprint: true, allowEmptyArchive: true
            archiveArtifacts artifacts: 'test-results/**', fingerprint: true, allowEmptyArchive: true
        }
        success {
            echo '✅ All tests passed!'
        }
        unstable {
            echo '⚠️ Some tests failed — check the reports above.'
        }
        failure {
            echo '❌ Pipeline failed — check console output for details.'
        }
    }
}
