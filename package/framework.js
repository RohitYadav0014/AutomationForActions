#!/usr/bin/env node
"use strict";var C=Object.create;var b=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var F=Object.getPrototypeOf,T=Object.prototype.hasOwnProperty;var _=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of $(e))!T.call(r,n)&&n!==t&&b(r,n,{get:()=>e[n],enumerable:!(s=O(e,n))||s.enumerable});return r};var o=(r,e,t)=>(t=r!=null?C(F(r)):{},_(e||!r||!r.__esModule?b(t,"default",{value:r,enumerable:!0}):t,r));var S=require("child_process"),I=o(require("path")),g=o(require("fs"));var E=(i=>(i[i.DEBUG=0]="DEBUG",i[i.INFO=1]="INFO",i[i.WARN=2]="WARN",i[i.ERROR=3]="ERROR",i[i.SILENT=4]="SILENT",i))(E||{}),y={DEBUG:"\x1B[36m",INFO:"\x1B[32m",WARN:"\x1B[33m",ERROR:"\x1B[31m",RESET:"\x1B[0m"},M={DEBUG:"\u{1F50D}",INFO:"\u2705",WARN:"\u26A0\uFE0F",ERROR:"\u274C"},a=class r{static{this.globalLevel=1}constructor(e){this.component=e}static setLevel(e){r.globalLevel=e}static getLevel(){let e=process.env.LOG_LEVEL?.toUpperCase();return e&&e in E?E[e]:r.globalLevel}formatMessage(e,t){let s=new Date().toISOString(),n=M[e]||"",i=y[e]||"",u=y.RESET;return`${i}${n} [${s}] [${e}] [${this.component}]${u} ${t}`}debug(e,...t){r.getLevel()<=0&&console.log(this.formatMessage("DEBUG",e),...t)}info(e,...t){r.getLevel()<=1&&console.log(this.formatMessage("INFO",e),...t)}warn(e,...t){r.getLevel()<=2&&console.warn(this.formatMessage("WARN",e),...t)}error(e,...t){r.getLevel()<=3&&console.error(this.formatMessage("ERROR",e),...t)}step(e,t){this.info(`Step ${e}: ${t}`)}testStart(e){this.info(`\u2501\u2501\u2501 TEST START: ${e} \u2501\u2501\u2501`)}testEnd(e,t){let s=t==="PASS"?"\u2705":t==="FAIL"?"\u274C":"\u23ED\uFE0F";this.info(`\u2501\u2501\u2501 TEST ${t}: ${e} ${s} \u2501\u2501\u2501`)}separator(){r.getLevel()<=1&&console.log("\u2500".repeat(80))}};var P=o(require("dotenv")),m=o(require("path")),f=o(require("fs"));P.config();function D(r){if(!r)return{};let e=m.isAbsolute(r)?r:m.join(process.cwd(),r);if(!f.existsSync(e))return console.warn(`\u26A0\uFE0F  Client config not found: ${e}`),{};try{let t=f.readFileSync(e,"utf-8");return JSON.parse(t)}catch(t){return console.error(`\u274C Failed to parse client config: ${e}`,t),{}}}function U(r){let e=D(r);return{projectName:e.projectName||process.env.PWG_ENV_PROJECT||"Project",suiteName:e.suiteName||process.env.PWG_ENV_SUITE_NAME||"Test Suite",suiteDescription:e.suiteDescription||process.env.PWG_ENV_SUITE_DESC||"Regression Testing",crmUrl:e.crmUrl||process.env.PWG_CRM_URL||"https://demo.us.espocrm.com/",crmUsername:process.env.PWG_CRM_USERNAME,crmPassword:process.env.PWG_CRM_PASSWORD,smtpHost:e.smtpHost||process.env.SMTP_HOST||"smtp.gmail.com",smtpPort:e.smtpPort||parseInt(process.env.SMTP_PORT||"587"),smtpSecure:e.smtpSecure||!1,gmailUser:process.env.GMAIL_USER||"",gmailAppPassword:process.env.GMAIL_APP_PASSWORD||"",emailFrom:process.env.PWG_EMAIL_FROM||"",emailTo:(process.env.PWG_EMAIL_ID||"").split(",").map(s=>s.trim()).filter(Boolean),emailCc:process.env.PWG_EMAIL_CC||"",headless:e.headless??(process.env.HEADLESS==="true"||!!process.env.CI),workers:e.workers||parseInt(process.env.WORKERS||"1"),retries:e.retries??(process.env.CI?2:0),timeout:e.timeout||parseInt(process.env.TEST_TIMEOUT||"300000"),browsers:e.browsers||["chromium"],reporters:e.reporters||["line","html","allure-playwright"],allureEnabled:e.allureEnabled??!0,emailReportEnabled:e.emailReportEnabled??!0,isCI:!!process.env.CI,buildUrl:process.env.BUILD_URL,buildNumber:process.env.BUILD_NUMBER}}var x=null;function k(r){return x||(x=U(r)),x}var d=o(require("crypto")),h=o(require("fs")),N=o(require("path")),l=o(require("os"));var c=new a("License"),j=process.env.LICENSE_SECRET||"enterprise-playwright-framework-2026";function L(r,e,t){let s=`${r}:${e}:${t}`,n=d.createHmac("sha256",j);return n.update(s),n.digest("hex")}function w(){let r=l.hostname(),e=l.platform(),t=l.cpus().map(n=>n.model).join(","),s=`${r}:${e}:${t}`;return d.createHash("md5").update(s).digest("hex")}function G(r){c.info(`Validating license for client: ${r.clientName}`);let e=L(r.clientId,r.clientName,r.expiresAt);if(r.licenseKey!==e)return c.error("Invalid license key"),{valid:!1,message:"\u274C Invalid license key. Contact your framework provider."};let t=new Date(r.expiresAt),s=new Date;if(s>t)return c.error(`License expired on ${r.expiresAt}`),{valid:!1,message:`\u274C License expired on ${r.expiresAt}. Please renew.`};let n=Math.ceil((t.getTime()-s.getTime())/(1e3*60*60*24));if(r.machineId){let i=w();if(r.machineId!==i)return c.error("Machine ID mismatch \u2014 license is locked to a different machine"),{valid:!1,message:"\u274C License is locked to a different machine. Contact support."}}return n<=30&&c.warn(`License expiring in ${n} days`),c.info(`License valid \u2014 ${n} days remaining`),{valid:!0,message:`\u2705 License valid. Expires in ${n} days.`,expiresIn:n,features:r.features}}function W(r){let e=r||N.join(process.cwd(),"license.json");if(!h.existsSync(e))return c.warn(`License file not found: ${e}`),null;try{let t=h.readFileSync(e,"utf-8");return JSON.parse(t)}catch(t){return c.error("Failed to parse license file",t),null}}async function v(r){let e=W(r);return e?G(e):{valid:!1,message:"\u274C No license file found. Place license.json in the project root."}}var oe=new a("Runner"),p=class{constructor(e){this.cfg=k(e),this.logger=new a("FrameworkRunner")}async preExecution(e){if(this.logger.separator(),this.logger.info("Enterprise Playwright Framework"),this.logger.info(`Project: ${this.cfg.projectName}`),this.logger.info(`Suite: ${this.cfg.suiteName}`),this.logger.separator(),e.skipLicense)this.logger.warn("License check skipped (development mode)");else{this.logger.info("Validating license...");let t=await v(e.licensePath);if(console.log(t.message),!t.valid)return this.logger.error("Framework execution blocked \u2014 invalid license"),!1;t.expiresIn&&t.expiresIn<=30&&this.logger.warn(`License expires in ${t.expiresIn} days \u2014 renew soon`)}return this.cleanAllureResults(),!0}cleanAllureResults(){let e=I.join(process.cwd(),"allure-results");g.existsSync(e)&&(g.rmSync(e,{recursive:!0,force:!0}),this.logger.info("Cleaned allure-results directory"))}buildCommand(e){let t=["npx","playwright","test"];return e.testFile&&t.push(e.testFile),e.grep&&t.push("--grep",`"${e.grep}"`),(e.headed||!this.cfg.headless)&&t.push("--headed"),e.project&&t.push("--project",e.project),e.workers&&e.workers>0?t.push("--workers",e.workers.toString()):this.cfg.workers&&this.cfg.workers>0&&t.push("--workers",this.cfg.workers.toString()),e.retries!==void 0&&t.push("--retries",e.retries.toString()),t.join(" ")}async execute(e){let t=this.buildCommand(e);this.logger.info(`Executing: ${t}`),this.logger.separator();try{return(0,S.execSync)(t,{stdio:"inherit",cwd:process.cwd(),env:{...process.env,PWG_ENV_PROJECT:this.cfg.projectName,PWG_ENV_SUITE_NAME:this.cfg.suiteName}}),this.logger.info("Test execution completed successfully"),0}catch(s){return this.logger.error("Test execution completed with failures"),s.status||1}}async postExecution(){this.logger.separator(),this.logger.info("Post-execution: Generating reports..."),this.cfg.allureEnabled&&await this.generateAllureReport(),this.logger.info("Post-execution complete"),this.logger.separator()}async generateAllureReport(){let e=I.join(process.cwd(),"allure-results");if(!g.existsSync(e)){this.logger.warn("No allure-results found \u2014 skipping Allure report generation");return}try{this.logger.info("Generating Allure report..."),(0,S.execSync)("npx allure generate ./allure-results -o ./allure-report --clean",{stdio:"inherit",cwd:process.cwd()}),this.logger.info("Allure report generated at ./allure-report")}catch(t){this.logger.error("Failed to generate Allure report",t)}}async run(e={}){if(!await this.preExecution(e))return 1;let s=await this.execute(e);return await this.postExecution(),s}};var V=new a("CLI"),A="1.0.0";function B(r){let e=r.slice(2),t=e[0]||"help",s={};for(let n=1;n<e.length;n++){let i=e[n];if(i.startsWith("--")){let u=i.replace("--",""),R=e[n+1];R&&!R.startsWith("--")?(s[u]=R,n++):s[u]=!0}}return{command:t,options:s}}function K(){console.log(`
\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557
\u2551       Enterprise Playwright Framework v${A}            \u2551
\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255D

USAGE:
  npx epf <command> [options]

COMMANDS:
  run         Execute test suite
  license     License management
  report      Generate Allure report
  version     Show version
  help        Show this help

RUN OPTIONS:
  --config <path>     Client configuration file (JSON)
  --license <path>    License file path
  --test <file>       Specific test file to run
  --grep <pattern>    Filter tests by name pattern
  --headed            Run browsers in headed mode
  --project <name>    Browser project (chromium/firefox/webkit)
  --workers <n>       Parallel workers count
  --retries <n>       Retry count for failed tests
  --skip-license      Skip license check (dev only)

LICENSE OPTIONS:
  --generate          Generate license key
  --validate          Validate current license
  --machine-id        Show machine ID

EXAMPLES:
  npx epf run
  npx epf run --config configs/client1.json --headed
  npx epf run --test lead.spec.ts --grep "TC01"
  npx epf license --validate
  npx epf report
`)}async function H(r){let e={configPath:r.config,licensePath:r.license,testFile:r.test,grep:r.grep,headed:!!r.headed,project:r.project,workers:r.workers?parseInt(r.workers):void 0,retries:r.retries?parseInt(r.retries):void 0,skipLicense:!!r["skip-license"]};return await new p(e.configPath).run(e)}async function J(r){if(r["machine-id"]){console.log(`Machine ID: ${w()}`);return}if(r.generate){let e=r["client-id"]||"CLIENT001",t=r["client-name"]||"Demo Client",s=r.expires||new Date(Date.now()+365*24*60*60*1e3).toISOString().split("T")[0],n=L(e,t,s);console.log(`
Generated License Key:`),console.log(`  Client ID:    ${e}`),console.log(`  Client Name:  ${t}`),console.log(`  Expires At:   ${s}`),console.log(`  License Key:  ${n}`),console.log(`  Machine ID:   ${w()}`),console.log(`
Place this in your license.json file.`);return}if(r.validate){let e=await v(r.path);console.log(e.message),e.features&&console.log(`Licensed features: ${e.features.join(", ")}`);return}console.log("Use --generate, --validate, or --machine-id")}async function X(){await new p().generateAllureReport()}async function q(){let{command:r,options:e}=B(process.argv);switch(r){case"run":let t=await H(e);process.exit(t);break;case"license":await J(e);break;case"report":await X();break;case"version":console.log(`Enterprise Playwright Framework v${A}`);break;default:K();break}}q().catch(r=>{V.error("Fatal error:",r),process.exit(1)});
